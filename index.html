<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instant Video Call</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.3.1/peerjs.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        video { width: 45%; border: 2px solid black; margin: 10px; }
    </style>
</head>
<body>
    <h2>Instant Video Call</h2>
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
    
    <script>
        let localStream;
        let peer = new Peer(); // Connect to PeerJS public server
        let connected = false; // To avoid multiple connections

        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                document.getElementById("localVideo").srcObject = stream;
            })
            .catch(error => console.error("Error accessing camera/microphone:", error));

        peer.on('open', id => {
            console.log("Your Peer ID: " + id);

            // Check for existing peers on the public PeerJS server
            fetch('https://0.peerjs.com/peers')
                .then(response => response.json())
                .then(peers => {
                    let otherPeers = peers.filter(p => p !== id); // Exclude self
                    if (otherPeers.length > 0 && !connected) {
                        console.log("Connecting to:", otherPeers[0]);
                        let call = peer.call(otherPeers[0], localStream);
                        call.on('stream', remoteStream => {
                            document.getElementById("remoteVideo").srcObject = remoteStream;
                        });
                        connected = true;
                    }
                })
                .catch(err => console.error("Error fetching peers:", err));
        });

        peer.on('call', call => {
            if (!connected) {
                call.answer(localStream);
                call.on('stream', remoteStream => {
                    document.getElementById("remoteVideo").srcObject = remoteStream;
                });
                connected = true;
            }
        });
    </script>
</body>
</html>
